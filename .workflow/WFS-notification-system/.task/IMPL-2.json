{
  "id": "IMPL-2",
  "title": "通知服务层",
  "status": "pending",
  "meta": {
    "priority": "high",
    "estimated_effort": "medium",
    "dependencies": ["IMPL-1"],
    "blocked_by": ["IMPL-1"],
    "focus_paths": ["src/notifications/"]
  },
  "context": {
    "description": "创建 NotificationService 服务类，负责与 Supabase 后端交互。参考 HotspotService 和 DifyService 的模式，实现通知的 CRUD 操作、未读数量统计、标记已读等核心业务逻辑。使用 QNetworkAccessManager 进行 HTTP 请求。",
    "acceptance_criteria": [
      "2个文件创建: 验证 ls src/notifications/NotificationService.{h,cpp} | wc -l = 2",
      "6个公有方法: fetchNotifications(), fetchUnreadCount(), markAsRead(id), markAllAsRead(), createNotification(notification), deleteNotification(id)",
      "5个信号: notificationsReceived(QList), unreadCountChanged(int), notificationMarkedRead(id), errorOccurred(QString), loadingStateChanged(bool)",
      "1个 Supabase 表配置: notifications 表访问端点",
      "HTTP 请求使用 QNetworkAccessManager 与 Supabase REST API 交互"
    ],
    "reference_patterns": [
      "src/services/HotspotService.h - 服务层结构模式",
      "src/services/DifyService.h - 网络请求+信号槽模式",
      "src/auth/supabase/supabaseclient.h - Supabase 认证请求模式"
    ]
  },
  "flow_control": {
    "pre_analysis": [
      {
        "step": "load_reference_services",
        "commands": [
          "Read(src/services/HotspotService.h)",
          "Read(src/services/DifyService.h)",
          "Read(src/auth/supabase/supabaseclient.h)"
        ],
        "output_to": "reference_services"
      },
      {
        "step": "load_supabase_config",
        "commands": [
          "Read(src/auth/supabase/supabaseconfig.h)"
        ],
        "output_to": "supabase_config"
      }
    ],
    "implementation_steps": [
      {
        "step": 1,
        "title": "创建服务类头文件",
        "description": "定义 NotificationService 类接口",
        "modification_points": [
          "创建 src/notifications/NotificationService.h",
          "包含 QObject, QNetworkAccessManager, QNetworkReply",
          "包含 models/Notification.h",
          "声明 6 个公有方法",
          "声明 5 个信号"
        ],
        "logic_flow": [
          "添加头文件保护",
          "继承 QObject",
          "声明 Q_OBJECT 宏",
          "声明公有构造函数和析构函数",
          "声明公有业务方法",
          "声明信号"
        ],
        "depends_on": [],
        "output": "service_header"
      },
      {
        "step": 2,
        "title": "实现网络请求基础设施",
        "description": "实现 Supabase REST API 调用的通用方法",
        "modification_points": [
          "创建 src/notifications/NotificationService.cpp",
          "初始化 m_networkManager",
          "实现 createRequest() 创建带认证头的请求",
          "配置 Supabase notifications 表端点"
        ],
        "logic_flow": [
          "构造函数初始化 QNetworkAccessManager",
          "设置 Supabase URL 和 API Key",
          "创建通用请求头: apikey, Authorization, Content-Type"
        ],
        "depends_on": [1],
        "output": "network_infrastructure"
      },
      {
        "step": 3,
        "title": "实现通知获取功能",
        "description": "实现 fetchNotifications 和 fetchUnreadCount 方法",
        "modification_points": [
          "实现 fetchNotifications(): GET /rest/v1/notifications",
          "实现 fetchUnreadCount(): GET /rest/v1/notifications?is_read=eq.false&select=count",
          "实现 onFetchNotificationsFinished() 槽函数",
          "实现 onFetchUnreadCountFinished() 槽函数",
          "发射 notificationsReceived 和 unreadCountChanged 信号"
        ],
        "logic_flow": [
          "发送 GET 请求",
          "解析 JSON 数组响应",
          "转换为 QList<Notification>",
          "发射信号通知 UI"
        ],
        "depends_on": [2],
        "output": "fetch_methods"
      },
      {
        "step": 4,
        "title": "实现标记已读功能",
        "description": "实现 markAsRead 和 markAllAsRead 方法",
        "modification_points": [
          "实现 markAsRead(id): PATCH /rest/v1/notifications?id=eq.{id}",
          "实现 markAllAsRead(): PATCH /rest/v1/notifications?receiver_id=eq.{userId}",
          "实现 onMarkAsReadFinished() 槽函数",
          "发射 notificationMarkedRead 信号"
        ],
        "logic_flow": [
          "发送 PATCH 请求，body: {is_read: true}",
          "成功后发射信号",
          "触发 unreadCount 重新获取"
        ],
        "depends_on": [3],
        "output": "mark_read_methods"
      },
      {
        "step": 5,
        "title": "实现错误处理",
        "description": "添加网络错误和 Supabase 错误处理",
        "modification_points": [
          "实现 onNetworkError() 槽函数",
          "实现 onSslErrors() 槽函数",
          "解析 Supabase 错误响应 JSON",
          "发射 errorOccurred 信号"
        ],
        "logic_flow": [
          "连接 QNetworkReply::errorOccurred 信号",
          "连接 QNetworkReply::sslErrors 信号",
          "解析错误 JSON 获取 message 字段",
          "发射用户友好的错误信息"
        ],
        "depends_on": [4],
        "output": "error_handling"
      }
    ],
    "validation": [
      "验证文件存在: ls src/notifications/NotificationService.{h,cpp}",
      "验证方法签名: grep -c 'fetchNotifications\\|fetchUnreadCount\\|markAsRead\\|markAllAsRead' src/notifications/NotificationService.h = 4",
      "验证信号声明: grep -c 'signals:' src/notifications/NotificationService.h = 1"
    ],
    "target_files": [
      "src/notifications/NotificationService.h:new:0-100",
      "src/notifications/NotificationService.cpp:new:0-250"
    ]
  }
}
