{
  "id": "IMPL-4",
  "title": "主窗口集成",
  "status": "pending",
  "meta": {
    "priority": "high",
    "estimated_effort": "medium",
    "dependencies": ["IMPL-3"],
    "blocked_by": ["IMPL-3"],
    "focus_paths": ["src/dashboard/"]
  },
  "context": {
    "description": "将通知系统集成到 ModernMainWindow 主窗口。连接现有的 notificationBtn 按钮（位于 Line 1391），添加 NotificationBadge 小红点到按钮上，实现点击弹出 NotificationWidget，连接 NotificationService 信号槽，实现通知的自动刷新和未读数量更新。",
    "acceptance_criteria": [
      "修改 2 个文件: modernmainwindow.h 添加 3 个新成员, modernmainwindow.cpp 添加约 80 行集成代码",
      "3个新成员变量: NotificationService*, NotificationWidget*, NotificationBadge*",
      "notificationBtn 点击事件连接到显示 NotificationWidget 弹窗",
      "NotificationBadge 叠加在 notificationBtn 右上角显示未读数量",
      "应用启动时自动调用 fetchNotifications() 和 fetchUnreadCount()",
      "1个定时器: 每 60 秒自动刷新未读数量"
    ],
    "reference_patterns": [
      "src/dashboard/modernmainwindow.cpp:1391 - notificationBtn 创建位置",
      "m_hotspotWidget 和 m_hotspotService 的集成模式",
      "m_difyService 的初始化和信号连接模式"
    ]
  },
  "flow_control": {
    "pre_analysis": [
      {
        "step": "load_main_window",
        "commands": [
          "Read(src/dashboard/modernmainwindow.h)",
          "Read(src/dashboard/modernmainwindow.cpp:1380-1470)"
        ],
        "output_to": "main_window_context"
      },
      {
        "step": "find_initialization_pattern",
        "commands": [
          "bash(grep -n 'm_hotspotService\\|m_difyService' src/dashboard/modernmainwindow.cpp | head -20)"
        ],
        "output_to": "service_init_pattern"
      }
    ],
    "implementation_steps": [
      {
        "step": 1,
        "title": "添加头文件和成员声明",
        "description": "在 modernmainwindow.h 中添加通知相关声明",
        "modification_points": [
          "添加前向声明: class NotificationService; class NotificationWidget; class NotificationBadge;",
          "添加私有成员: NotificationService *m_notificationService = nullptr;",
          "添加私有成员: NotificationWidget *m_notificationWidget = nullptr;",
          "添加私有成员: NotificationBadge *m_notificationBadge = nullptr;",
          "添加私有成员: QTimer *m_notificationRefreshTimer = nullptr;"
        ],
        "logic_flow": [
          "在 class DataAnalyticsWidget; 后添加 3 个前向声明",
          "在 m_dataAnalyticsWidget 成员后添加 4 个新成员变量"
        ],
        "depends_on": [],
        "output": "header_declarations"
      },
      {
        "step": 2,
        "title": "添加包含和初始化代码",
        "description": "在 modernmainwindow.cpp 中初始化通知组件",
        "modification_points": [
          "添加 #include 语句: NotificationService.h, NotificationWidget.h, NotificationBadge.h",
          "在构造函数中创建 m_notificationService = new NotificationService(this);",
          "在构造函数中创建 m_notificationWidget = new NotificationWidget(this);",
          "设置 m_notificationWidget 为弹窗模式: setWindowFlags(Qt::Popup)"
        ],
        "logic_flow": [
          "在 #include 区域添加新头文件",
          "在 initUI() 或构造函数末尾初始化服务和组件",
          "设置 NotificationWidget 的 parent 为 this"
        ],
        "depends_on": [1],
        "output": "initialization"
      },
      {
        "step": 3,
        "title": "集成 NotificationBadge 到按钮",
        "description": "将小红点叠加到 notificationBtn 右上角",
        "modification_points": [
          "在 createHeaderWidget() 函数中，notificationBtn 创建后添加 NotificationBadge",
          "使用 QVBoxLayout 或绝对定位将 badge 放置在按钮右上角",
          "初始隐藏 badge (setCount(0))"
        ],
        "logic_flow": [
          "创建 m_notificationBadge = new NotificationBadge(notificationBtn);",
          "设置 badge 的位置: move(notificationBtn->width()-14, -4);",
          "或使用 QStackedLayout 叠加"
        ],
        "depends_on": [2],
        "output": "badge_integration"
      },
      {
        "step": 4,
        "title": "连接信号槽",
        "description": "连接 NotificationService 和 UI 组件的信号槽",
        "modification_points": [
          "连接 notificationBtn->clicked() 到显示弹窗的槽函数",
          "连接 m_notificationService->notificationsReceived 到 m_notificationWidget->setNotifications",
          "连接 m_notificationService->unreadCountChanged 到 m_notificationBadge->setCount",
          "连接 m_notificationWidget->notificationClicked 到 m_notificationService->markAsRead",
          "连接 m_notificationWidget->markAllReadClicked 到 m_notificationService->markAllAsRead"
        ],
        "logic_flow": [
          "使用 connect() 宏连接信号槽",
          "点击按钮显示弹窗: m_notificationWidget->show() + adjustPopupPosition()",
          "服务信号驱动 UI 更新"
        ],
        "depends_on": [3],
        "output": "signal_connections"
      },
      {
        "step": 5,
        "title": "实现自动刷新",
        "description": "添加定时器自动刷新未读数量",
        "modification_points": [
          "创建 m_notificationRefreshTimer = new QTimer(this);",
          "设置间隔 60000ms (60秒)",
          "连接 timeout 到 m_notificationService->fetchUnreadCount()",
          "在构造函数末尾调用 fetchNotifications() 初始加载"
        ],
        "logic_flow": [
          "创建定时器",
          "设置 60 秒间隔",
          "connect(timer, &QTimer::timeout, service, &NotificationService::fetchUnreadCount)",
          "timer->start()",
          "初始加载: m_notificationService->fetchNotifications()"
        ],
        "depends_on": [4],
        "output": "auto_refresh"
      }
    ],
    "validation": [
      "验证头文件修改: grep -c 'NotificationService\\|NotificationWidget\\|NotificationBadge' src/dashboard/modernmainwindow.h >= 3",
      "验证信号连接: grep -c 'connect.*m_notificationService\\|connect.*notificationBtn' src/dashboard/modernmainwindow.cpp >= 4",
      "编译验证: cmake --build build --target AILoginSystem"
    ],
    "target_files": [
      "src/dashboard/modernmainwindow.h:modify:add-4-members",
      "src/dashboard/modernmainwindow.cpp:modify:add-80-lines"
    ]
  }
}
