{
  "metadata": {
    "task_description": "构建站内通知系统，支持作业提交通知、请假审批通知、成绩发布通知、系统公告。需要通知中心UI组件、通知数据模型、NotificationService服务层、Supabase后端集成，支持未读数量小红点、全部已读功能、通知列表展示。",
    "timestamp": "2026-02-01T00:00:00Z",
    "session_id": "WFS-notification-system",
    "keywords": [
      "notification",
      "通知",
      "Supabase",
      "Qt",
      "UI",
      "service",
      "model",
      "unread",
      "badge",
      "作业",
      "请假",
      "成绩",
      "公告"
    ],
    "complexity": "medium",
    "tech_stack": {
      "language": "C++17",
      "framework": "Qt 6",
      "qt_modules": [
        "Widgets",
        "Network",
        "Charts",
        "QuickWidgets",
        "Svg",
        "SvgWidgets",
        "PrintSupport"
      ],
      "backend": "Supabase (PostgreSQL)",
      "build_system": "CMake 3.16+"
    }
  },
  "project_context": {
    "architecture_patterns": [
      "MVC分离 - UI组件与Service层分离",
      "信号槽机制 - Qt信号槽进行组件通信",
      "依赖注入 - 服务层通过setter注入",
      "接口抽象 - IDataSource接口支持Mock和真实数据源",
      "单例模式 - 部分Service使用单例(AnalyticsDataService)"
    ],
    "coding_conventions": {
      "naming": {
        "classes": "PascalCase (如 DifyService, NewsItem)",
        "member_variables": "m_ 前缀 (如 m_networkManager)",
        "signals_slots": "camelCase (如 messageReceived, onReplyFinished)",
        "constants": "UPPER_SNAKE_CASE (如 PATRIOTIC_RED)"
      },
      "file_organization": {
        "headers": "与cpp同名，放在同目录",
        "models": "src/模块名/models/",
        "interfaces": "src/模块名/interfaces/",
        "ui": "src/模块名/ui/",
        "services": "src/services/"
      },
      "error_handling": {
        "pattern": "信号发射错误信息 (errorOccurred signal)",
        "network_errors": "详细错误类型枚举处理"
      },
      "async_patterns": {
        "network": "QNetworkAccessManager + 信号槽",
        "streaming": "SSE流式响应处理"
      },
      "documentation": {
        "style": "中文注释和日志",
        "doxygen": "@brief, @param 标注"
      }
    },
    "ui_patterns": {
      "color_system": "StyleConfig.h 定义统一色彩变量",
      "card_style": "圆角卡片 + 阴影效果",
      "sidebar": "导航侧边栏 + 内容区堆栈切换",
      "header": "顶部工具栏含搜索、通知、头像"
    }
  },
  "assets": {
    "documentation": [
      {
        "path": "CLAUDE.md",
        "scope": "project-wide",
        "contains": [
          "项目概述",
          "技术栈说明",
          "目录结构",
          "代码规范"
        ],
        "relevance_score": 0.95
      }
    ],
    "source_code": {
      "integration_points": [
        {
          "path": "src/dashboard/modernmainwindow.h",
          "role": "main-window-header",
          "description": "主界面，顶部已有notificationBtn占位，需连接通知功能",
          "key_members": [
            "notificationBtn",
            "headerWidget",
            "createHeaderWidget()"
          ],
          "relevance_score": 0.99
        },
        {
          "path": "src/dashboard/modernmainwindow.cpp",
          "role": "main-window-implementation",
          "description": "createHeaderWidget()方法创建顶部工具栏，通知按钮已存在但未连接功能",
          "integration_location": "Line 1391-1461",
          "relevance_score": 0.99
        }
      ],
      "service_patterns": [
        {
          "path": "src/services/DifyService.h",
          "role": "service-pattern-reference",
          "description": "网络服务层模式参考 - QNetworkAccessManager + 信号槽",
          "patterns": [
            "QObject继承",
            "QNetworkAccessManager成员",
            "请求/响应信号",
            "错误处理信号"
          ],
          "relevance_score": 0.92
        },
        {
          "path": "src/services/HotspotService.h",
          "role": "service-pattern-reference",
          "description": "业务服务层模式参考 - 缓存数据 + 依赖注入",
          "patterns": [
            "依赖注入(setProvider)",
            "数据缓存(cachedNews)",
            "加载状态信号"
          ],
          "relevance_score": 0.90
        },
        {
          "path": "src/services/PaperService.h",
          "role": "service-pattern-reference",
          "description": "Supabase REST API服务模式参考",
          "patterns": [
            "CRUD操作",
            "RequestType枚举",
            "认证令牌管理"
          ],
          "relevance_score": 0.88
        },
        {
          "path": "src/analytics/AnalyticsDataService.h",
          "role": "service-pattern-reference",
          "description": "单例服务模式参考",
          "patterns": [
            "单例instance()",
            "数据刷新信号"
          ],
          "relevance_score": 0.82
        }
      ],
      "supabase_integration": [
        {
          "path": "src/auth/supabase/supabaseclient.h",
          "role": "supabase-client",
          "description": "Supabase客户端模式参考 - 认证和REST API调用",
          "patterns": [
            "QNetworkAccessManager",
            "sendRequest/sendGetRequest",
            "handle*Response",
            "SSL错误处理"
          ],
          "relevance_score": 0.95
        },
        {
          "path": "src/auth/supabase/supabaseclient.cpp",
          "role": "supabase-client-impl",
          "description": "Supabase API调用实现参考",
          "relevance_score": 0.93
        },
        {
          "path": "src/auth/supabase/supabaseconfig.h",
          "role": "supabase-config",
          "description": "Supabase配置常量",
          "constants": [
            "SUPABASE_URL",
            "SUPABASE_ANON_KEY",
            "USERS_TABLE"
          ],
          "relevance_score": 0.90
        }
      ],
      "model_patterns": [
        {
          "path": "src/analytics/models/Student.h",
          "role": "model-pattern-reference",
          "description": "数据模型模式参考 - fromJson/toJson + getter/setter",
          "patterns": [
            "静态fromJson工厂方法",
            "toJson序列化",
            "m_前缀成员变量",
            "getter/setter"
          ],
          "relevance_score": 0.90
        },
        {
          "path": "src/hotspot/NewsItem.h",
          "role": "model-pattern-reference",
          "description": "轻量数据结构模式参考 - struct + isValid",
          "patterns": [
            "struct定义",
            "isValid()验证",
            "QDateTime时间字段"
          ],
          "relevance_score": 0.88
        },
        {
          "path": "src/services/PaperService.h",
          "role": "model-pattern-reference",
          "description": "内嵌struct模式参考 - Paper和PaperQuestion",
          "patterns": [
            "struct内嵌在Service头文件",
            "fromJson/toJson"
          ],
          "relevance_score": 0.85
        }
      ],
      "ui_patterns": [
        {
          "path": "src/ui/ChatHistoryWidget.h",
          "role": "ui-pattern-reference",
          "description": "列表展示UI组件参考",
          "relevance_score": 0.80
        },
        {
          "path": "src/analytics/ui/PersonalAnalyticsPage.h",
          "role": "ui-pattern-reference",
          "description": "页面组件模式参考",
          "relevance_score": 0.78
        },
        {
          "path": "src/shared/StyleConfig.h",
          "role": "style-constants",
          "description": "UI样式常量定义",
          "constants": [
            "PATRIOTIC_RED",
            "TEXT_PRIMARY",
            "BG_CARD",
            "RADIUS_*"
          ],
          "relevance_score": 0.92
        }
      ],
      "interface_patterns": [
        {
          "path": "src/analytics/interfaces/IAnalyticsDataSource.h",
          "role": "interface-pattern-reference",
          "description": "数据源接口模式参考 - 纯虚函数",
          "patterns": [
            "纯虚析构函数",
            "纯虚方法定义",
            "支持Mock实现"
          ],
          "relevance_score": 0.85
        },
        {
          "path": "src/hotspot/INewsProvider.h",
          "role": "interface-pattern-reference",
          "description": "提供者接口模式参考",
          "relevance_score": 0.82
        }
      ]
    },
    "config": [
      {
        "path": "CMakeLists.txt",
        "role": "build-config",
        "description": "CMake构建配置，需添加新文件到PROJECT_SOURCES",
        "relevance_score": 0.95
      }
    ],
    "resources": [
      {
        "path": "resources/icons/notification.svg",
        "role": "existing-icon",
        "description": "已有通知图标，可复用",
        "relevance_score": 0.85
      }
    ]
  },
  "dependencies": {
    "internal": [
      {
        "from": "NotificationService (新建)",
        "to": "SupabaseConfig",
        "type": "config-dependency",
        "description": "使用Supabase配置进行API调用"
      },
      {
        "from": "NotificationWidget (新建)",
        "to": "NotificationService",
        "type": "service-dependency",
        "description": "UI组件依赖服务层获取数据"
      },
      {
        "from": "ModernMainWindow",
        "to": "NotificationWidget",
        "type": "ui-integration",
        "description": "主窗口集成通知组件"
      },
      {
        "from": "NotificationService",
        "to": "Notification (模型)",
        "type": "data-dependency",
        "description": "服务层操作通知数据模型"
      }
    ],
    "external": [
      {
        "package": "Qt6::Widgets",
        "usage": "UI组件基础"
      },
      {
        "package": "Qt6::Network",
        "usage": "Supabase API网络请求"
      },
      {
        "package": "Supabase REST API",
        "usage": "notifications表CRUD操作",
        "endpoints": [
          "/rest/v1/notifications",
          "/rest/v1/notifications?user_id=eq.{id}",
          "/rest/v1/notifications?id=eq.{id}"
        ]
      }
    ]
  },
  "implementation_plan": {
    "new_files": [
      {
        "path": "src/notifications/models/Notification.h",
        "type": "header",
        "description": "通知数据模型"
      },
      {
        "path": "src/notifications/models/Notification.cpp",
        "type": "source",
        "description": "通知模型实现"
      },
      {
        "path": "src/notifications/NotificationService.h",
        "type": "header",
        "description": "通知服务层接口"
      },
      {
        "path": "src/notifications/NotificationService.cpp",
        "type": "source",
        "description": "通知服务层实现"
      },
      {
        "path": "src/notifications/ui/NotificationWidget.h",
        "type": "header",
        "description": "通知中心UI组件"
      },
      {
        "path": "src/notifications/ui/NotificationWidget.cpp",
        "type": "source",
        "description": "通知中心UI实现"
      },
      {
        "path": "src/notifications/ui/NotificationBadge.h",
        "type": "header",
        "description": "未读数量小红点组件"
      },
      {
        "path": "src/notifications/ui/NotificationBadge.cpp",
        "type": "source",
        "description": "小红点组件实现"
      }
    ],
    "modified_files": [
      {
        "path": "src/dashboard/modernmainwindow.h",
        "changes": [
          "添加NotificationWidget前向声明",
          "添加NotificationService成员指针",
          "添加通知相关槽函数声明"
        ]
      },
      {
        "path": "src/dashboard/modernmainwindow.cpp",
        "changes": [
          "include通知头文件",
          "初始化NotificationService",
          "连接notificationBtn点击事件",
          "显示NotificationWidget弹窗"
        ]
      },
      {
        "path": "CMakeLists.txt",
        "changes": [
          "添加notifications模块文件到PROJECT_SOURCES"
        ]
      }
    ]
  },
  "conflict_detection": {
    "risk_level": "low",
    "risk_factors": {
      "existing_implementations": [
        "src/dashboard/modernmainwindow.h - notificationBtn已存在但未连接",
        "resources/icons/notification.svg - 图标已存在"
      ],
      "api_changes": false,
      "architecture_changes": false,
      "data_model_changes": true,
      "breaking_changes": []
    },
    "affected_modules": [
      "dashboard (主窗口集成)",
      "notifications (新建模块)"
    ],
    "integration_points": [
      {
        "location": "ModernMainWindow::createHeaderWidget()",
        "line": 1391,
        "description": "notificationBtn已创建，需添加clicked信号连接"
      }
    ],
    "mitigation_strategy": "增量添加 - 新建notifications模块，仅修改主窗口连接通知按钮",
    "supabase_schema_needed": {
      "table": "notifications",
      "columns": [
        "id (uuid, primary key)",
        "user_id (uuid, foreign key to auth.users)",
        "type (text: homework, leave, grade, announcement)",
        "title (text)",
        "content (text)",
        "is_read (boolean, default false)",
        "created_at (timestamptz)",
        "metadata (jsonb, optional)"
      ],
      "rls_policy": "用户只能读取自己的通知"
    }
  },
  "discovery_stats": {
    "files_analyzed": 52,
    "high_priority_files": 12,
    "medium_priority_files": 8,
    "patterns_identified": [
      "服务层模式 (DifyService, HotspotService, PaperService)",
      "数据模型模式 (Student, NewsItem, Paper)",
      "Supabase集成模式 (SupabaseClient)",
      "UI组件模式 (ChatWidget, DataAnalyticsWidget)",
      "接口抽象模式 (IAnalyticsDataSource, INewsProvider)"
    ],
    "integration_complexity": "low - 主窗口已有通知按钮占位"
  }
}
